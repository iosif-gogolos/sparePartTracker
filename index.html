<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retournierte Ersatzteile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/1.1.0/modern-normalize.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.0/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="icon" href="./assets/appicon.png" type="image/png">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        h1 {
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        .form-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .form-container label {
            font-weight: bold;
        }
        .form-container input, .form-container select, .form-container button {
            padding: 0.5rem;
            font-size: 1rem;
        }
        .form-container button {
            background-color: #003e70;
            color: white;
            border: none;
            cursor: pointer;
        }
        .form-container button:hover {
            background-color: #0056b3;
        }
        .hidden {
            display: none;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .stat {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 1rem;
            text-align: center;
            border-radius: 8px;
        }
        .stat h3 {
            margin-bottom: 0.5rem;
        }
        .recommendation-box {
            margin: 1rem 0;
            padding: 1rem;
            background-color: #e6f7ff;
            border-left: 4px solid #0056b3;
            border-radius: 8px;
        }

        .import-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .import-section h2 {
            margin-bottom: 1rem;
            color: #003e70;
            text-align: center;
        }

        #importForm {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        #importForm label {
            font-weight: bold;
        }

        #importForm input {
            padding: 0.5rem;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #importForm button {
            background-color: #0056b3;
            color: white;
            border: none;
            padding: 0.7rem;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        #importForm button:hover {
            background-color: #003e70;
        }
        
        .clear-button {
            margin-top: 1rem;
            background-color: #d9534f;
            color: white;
            border: none;
            padding: 0.7rem;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        .clear-button:hover {
            background-color: #c9302c;
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1rem 0;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #pageInfo {
            margin-right: 1rem;
        }

        /* Media Queries */
        @media (max-width: 768px) {
            .form-container {
                flex-direction: column;
            }

            .pagination-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .pagination-controls {
                margin-top: 1rem;
            }

            table {
                display: block;
                overflow-x: auto;
            }
        }

        .search-container {
                display: flex;
                align-items: center;
                margin-bottom: 1rem;
            }

            #searchInput {
                padding: 0.5rem;
                font-size: 1rem;
                border: 1px solid #ccc;
                border-radius: 4px;
                flex-grow: 1;
            }

            #searchButton, #clearSearchButton {
                background-color: #0056b3;
                color: white;
                border: none;
                padding: 0.5rem;
                font-size: 1rem;
                cursor: pointer;
                border-radius: 4px;
                margin-left: 0.5rem;
                transition: background-color 0.3s ease;
            }

            #searchButton:hover, #clearSearchButton:hover {
                background-color: #003e70;
            }
            #uploadImagesButton {
                background-color: #0056b3;
                color: white;
                border: none;
                padding: 0.5rem;
                font-size: 1rem;
                cursor: pointer;
                border-radius: 4px;
                margin-left: 0.5rem;
                transition: background-color 0.3s ease;
            }

            #uploadImagesButton:hover {
                background-color: #003e70;
            }

            #imagePreviewContainer {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                margin-top: 0.5rem;
            }

            .image-preview {
                width: 100px;
                height: 100px;
                object-fit: cover;
                border: 1px solid #ccc;
                border-radius: 4px;
                position: relative;
            }

            .image-preview img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .image-preview .remove-button {
                position: absolute;
                top: 0;
                right: 0;
                background-color: rgba(255, 0, 0, 0.7);
                color: white;
                border: none;
                cursor: pointer;
                font-size: 1rem;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .image-preview-overlay {
                position: fixed;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                display: none;
            }

            .image-preview-overlay img {
                max-width: 90%;
                max-height: 90%;
            }

            .image-preview-overlay .close-button {
                position: absolute;
                top: 20px;
                right: 20px;
                background: white;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
            }

            .ocr-result {
                margin-top: 0.5rem;
                background-color: f4f4f4;
                padding: 0.5rem;
                border: 1px solid #ddd;
                border-radius: 4px;
                border-radius: 4px;
                font-size: 0.9rem;
                color: #333;
            }

            .photo-guide {
                margin-top: 1rem;
                padding: 1rem;
                background-color: #e6f7ff;
                border-left: 4px solid #0056b3;
                border-radius: 8px;
                text-align: center;
            }

            .photo-guide h3 {
                margin-bottom: 0.5;
            }

            .photo-guide p {
                margin: 0;
                font-size: 1rem;
                color: #333;
            }

            .photo-confirmation-dialog {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                display: none;
            }

            .photo-confirmation-dialog .dialog-content {
                background: white;
                padding: 1rem;
                border-radius: 8px;
                text-align: center;
            }

            .photo-confirmation-dialog img {
                max-width: 100%;
                max-height: 300px;
                margin-bottom: 1rem;
            }

            .photo-confirmation-dialog button {
                background-color: #0056b3;
                color: white;
                border: none;
                padding: 0.5rem 1rem;
                font-size: 1rem;
                cursor: pointer;
                border-radius: 4px;
                margin: 0 0.5rem;
                transition: background-color 0.3s ease;
            }

            .photo-confirmation-dialog button:hover {
                background-color: #003e70;
            }

    </style>
</head>
<body>
    <div class="container">
        <h1>Station Markgröningen</h1>

        <div id="dashboard" class="hidden">
            <h2>Dashboard</h2>
            <div class="stats-grid">
                <div class="stat">
                    <h3>Anzahl nicht retournierter Teile</h3>
                    <p id="notReturnedCount">0</p>
                </div>
                <div class="stat">
                    <h3>Summe Preis (alle Ersatzteile)</h3>
                    <p id="totalPrice">0 €</p>
                </div>
                <div class="stat">
                    <h3>Davon Gutschrift<br/> im WAP</h3>
                    <p id="creditPrice">0 €</p>
                </div>
                <div class="stat">
                    <h3>Offener Betrag<br/>ohne Gutschrift im WAP</h3>
                    <p id="openAmount">0 €</p>
                </div>
            </div>
            <div id="recommendation" class="recommendation-box">
                <h3>Handlungsempfehlung</h3>
                <p id="recommendationText">Keine Empfehlungen verfügbar.</p>
            </div>
        </div>
        
        <form id="addPartForm" class="form-container">
            <label for="licensePlate">Kennzeichen</label>
            <input type="text" id="licensePlate" placeholder="Kennzeichen" required>
            <label for="partNumber">Teilenummer</label>
            <input type="text" id="partNumber" placeholder="Teilenummer" required>
            <label for="description">Teil-Bezeichnung</label>
            <input type="text" id="description" placeholder="Beschreibung">
            <label for="complaintDate">Reklamationsdatum</label>
            <input type="date" id="complaintDate" required>
            <label for="reason">Grund</label>
            <select id="reason">
                <option value="Beschädigt">Beschädigt</option>
                <option value="Falsch geliefert">Falsch geliefert</option>
            </select>
            <label for="price">Preis</label>
            <input type="text" id="price" placeholder="Preis">
            <label for="remarks">Bemerkung</label>
            <input type="text" id="remarks" placeholder="Bemerkung">

            <!-- Gutschrift vorhanden -->
            <label for="creditAvailable">Gutschrift vorhanden</label>
            <select id="creditAvailable">
                <option value="Ja">Ja</option>
                <option value="Nein" selected>Nein</option>
            </select>
            
            <!-- Fotoguide -->
            
            <div class="photo-guide" id="photoGuide">
                <h3>Fotoguide</h3>
                <label for="partImages">Bilder hochladen</label>
                <input type="file" id="partImages" accept="image/*" capture="environment" multiple class="hidden">

                <p id="photoGuideText">Foto 1: Bitte mach ein Foto vom Versandkarton</p>
                <button type="button" id="uploadImagesButton" title="Bilder hochladen">
                    <span class="material-icons">camera_alt</span>
                </button>
            </div>

            <div id="imagePreviewContainer"></div>

            <!-- Bilder hinzufügen 
            <label for="partImages">Bilder hochladen</label>
            <input type="file" id="partImages" accept="image/*" multiple class="hidden">
            <button type="button" id="uploadImagesButton" title="Bilder hochladen">
                <span class="material-icons">camera_alt</span>
            </button>
            <div id="imagePreviewContainer"></div>-->

            <!-- Bildvorschau-Overlay -->
            <div class="image-preview-overlay" id="imagePreviewOverlay">
                <button class="close-button" id="closePreviewButton">&times;</button>
                <img id="previewImage" src="" alt="Preview image">
                <div>
                    <button id="confirmImageButton">Bild bestätigen</button>
                    <button id="retakeImageButton">Bild erneut aufnehmen</button>
                </div>
            </div>

            <!-- Bildbestätigungs-Dialog -->
            <div class="photo-confirmation-dialog" id="photoConfirmationDialog">
                <div class="dialog-content">
                    <img id="confirmationImage" src="" alt="Confirmation image">
                    <p>Ist dieses Bild in Ordnung?</p>
                    <button id="confirmButton">Ja</button>
                    <button id="retakeButton">Nein</button>
                </div>
            </div>
            
            <!-- Submit button -->
            <button type="submit">Hinzufügen</button>
        </form>      

        <div class="pagination-container">
            <label for="entriesPerPage">Einträge pro Seite</label>
            <select id ="entriesPerPage">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>

        <div class="pagination-controls">
            <span id="pageInfo">Seite 1 von 1</span>
            <button id="prevPageButton">Vorherige Seite</button>
            <button id="nextPageButton">Nächste Seite</button>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Suchen...">
            <button id="searchButton" title="Suchen">
                <span class="material-icons">search</span>
            </button>
            <button id="clearSearchButton" class="hidden" title="Suche zurücksetzen">
                <span class="material-icons">close</span>
            </button>
        </div>

        <div class="image-preview-overlay" id="imagePreviewOverlay">
            <button class="close-button" id="closePreviewButton">&times;</button>
            <img id="previewImage" src="" alt="Preview image">

        </div>

        <table id="partsTable">
            <thead>
                <tr>
                    <th>Kennzeichen</th>
                    <th>Teilenummer</th>
                    <th>Beschreibung</th>
                    <th>Reklamationsdatum</th>
                    <th>Grund</th>
                    <th>Preis</th>
                    <th>Bemerkung</th>
                    <th>Gutschrift vorhanden</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dynamische Inhalte werden hier hinzugefügt -->
            </tbody>
        </table>

        <button id="exportButton" class="hidden">Liste Exportieren</button>    
        <button id="clearTableButton" class="clear-button">Tabelle leeren</button>

        <div id="importSection" class="import-section">
            <h2>Datei importieren</h2>
            <form id="importForm" class="form-container">
                <label for="importFile">Datei importieren (CSV oder XLSX)</label>
                <input type="file" id="importFile" accept=".csv, .xlsx">
                <button type="button" id="importButton">Importieren</button>
            </form>
        </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <!-- Usage of Tesseract.js for OCR-->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.1/dist/tesseract.min.js"></script>

    <script>
            const addPartForm = document.getElementById('addPartForm');
            const partsTableBody = document.querySelector('#partsTable tbody');
            const exportButton = document.getElementById('exportButton');
            const addButton = addPartForm.querySelector('button[type="submit"]');
            const clearTableButton = document.getElementById('clearTableButton');
            const entriesPerPageSelect = document.getElementById('entriesPerPage');
            const prevPageButton = document.getElementById('prevPageButton');
            const nextPageButton = document.getElementById('nextPageButton');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const clearSearchButton = document.getElementById('clearSearchButton');
            const partImagesInput = document.getElementById('partImages');
            const uploadImagesButton = document.getElementById('uploadImagesButton');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const imagePreviewOverlay = document.getElementById('imagePreviewOverlay');
            const previewImage = document.getElementById('previewImage');
            const closePreviewButton = document.getElementById('closePreviewButton');
            const photoGuideText = document.getElementById('photoGuideText');
            const startCameraButton = document.getElementById('startCameraButton');
            const confirmImageButton = document.getElementById('confirmImageButton');
            const retakeImageButton = document.getElementById('retakeImageButton');
            const photoGuideSteps = [
                "Foto 1: Bitte mach ein Foto vom Versandkarton",
                "Foto 2: Mache ein zweites Foto von Versandkarton",
                "Foto 3: Mache ein Foto vom verpackten Ersatzteil (in der Regel in der Folie im Karton)",
                "Foto 4: Mache ein zweites Foto vom verpackten Ersatzteil",
                "Foto 5: Mache ein Foto von dem beschädigten Ersatzteil",
                "Foto 6: Mache ein zweites Foto von dem beschädigten Ersatzteil",
                "Foto 7: Mache ein drittes Foto von dem beschädigten Ersatzteil",
                "Foto 8: Mache ein viertes Foto von dem beschädigten Ersatzteil"
            ];
            let currentStep = 0;
            let imageFiles = [];
            let uniqueId = 0;
            let isEditing = false;
            let editingId = null;
            let currentPage = 1;
            let entriesPerPage = parseInt(entriesPerPageSelect.value, 10);
            let storedParts = [];
            let filteredParts = [];

            uploadImagesButton.addEventListener('click', () => {
                partImagesInput.click();
            });


            startCameraButton.addEventListener('click', () => {
                partImagesInput.click();
            });
            /*
            partImagesInput.addEventListener('change', () => {
                if (partImagesInput.files.length > 0) {
                    const file = partImagesInput.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImage.src = e.target.result;
                        imagePreviewOverlay.style.display = 'flex';
                    };
                    reader.readAsDataURL(file);
                }
            });*/

            confirmImageButton.addEventListener('click', () => {
                const img = document.createElement('div');
                img.classList.add('image-preview');
                img.innerHTML = `
                    <img src="${previewImage.src}" alt="Preview">
                    <button class="remove-button" data-index="${currentStep}">&times;</button>
                `;
                imagePreviewContainer.appendChild(img);
                imageFiles.push(previewImage.src);
                currentStep++;
                if (currentStep < photoGuideSteps.length) {
                    photoGuideText.textContent = photoGuideSteps[currentStep];
                } else {
                    photoGuideText.textContent = "Alle Fotos aufgenommen.";
                }
                imagePreviewOverlay.style.display = 'none';
            });

            retakeImageButton.addEventListener('click', () => {
                partImagesInput.value = '';
                imagePreviewOverlay.style.display = 'none';
            });

            closePreviewButton.addEventListener('click', () => {
                imagePreviewOverlay.style.display = 'none';
            });

            imagePreviewContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-button')) {
                    const index = e.target.getAttribute('data-index');
                    imageFiles.splice(index, 1);
                    e.target.parentElement.remove();
                    currentStep--;
                    photoGuideText.textContent = photoGuideSteps[currentStep];
                }
            });

            addPartForm.addEventListener('submit', event => {
                event.preventDefault();

                const newPart = {
                    id: isEditing ? editingId : uniqueId++,
                    licensePlate: document.getElementById('licensePlate').value,
                    partNumber: document.getElementById('partNumber').value,
                    description: document.getElementById('description').value,
                    complaintDate: document.getElementById('complaintDate').value,
                    reason: document.getElementById('reason').value,
                    price: document.getElementById('price').value,
                    remarks: document.getElementById('remarks').value,
                    creditAvailable: document.getElementById('creditAvailable').value,
                    images: imageFiles
                };

                addPartToTable(newPart);
                savePartToStorage(newPart);

                addPartForm.reset();
                imagePreviewContainer.innerHTML = '';
                imageFiles = [];
                currentStep = 0;
                photoGuideText.textContent = photoGuideSteps[currentStep];
            });

            function addPartToTable(part) {
                const newRow = document.createElement('tr');
                newRow.setAttribute('data-id', part.id);

                for (const key in part) {
                    if (key === 'id') continue;
                    const cell = document.createElement('td');
                    cell.textContent = key === 'complaintDate' && part[key]
                        ? new Date(part[key]).toLocaleDateString('de-DE')
                        : part[key];
                    newRow.appendChild(cell);
                }

                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <button class="icon-button delete-btn" title="Löschen">
                        <span class="material-icons">delete</span>
                    </button>
                    <button class="icon-button edit-btn" title="Bearbeiten">
                        <span class="material-icons">edit</span>
                    </button>
                    <button class="icon-button view-images-btn" title="Bilder anzeigen">
                        <span class="material-icons">photo</span>
                    </button>
                `;
                actionsCell.querySelector('.delete-btn').addEventListener('click', () => {
                    if (confirm(`Sind Sie sicher, dass Sie den Eintrag mit dem Kennzeichen "${part.licensePlate}" löschen wollen?`))
                        removePartFromTable(part.id);
                });
                actionsCell.querySelector('.edit-btn').addEventListener('click', () => loadPartToForm(part));
                actionsCell.querySelector('.view-images-btn').addEventListener('click', () => {
                    if (part.images.length === 0) {
                        if (confirm("Es wurden noch keine Bilder hinzugefügt. Möchten Sie jetzt Bilder hinzufügen?")) {
                            partImagesInput.click();
                        }
                    } else {
                        viewImages(part.images);
                    }
                });
                newRow.appendChild(actionsCell);
                partsTableBody.appendChild(newRow);
            }

            function savePartToStorage(part) {
                const storedParts = JSON.parse(localStorage.getItem('partsData')) || [];
                storedParts.push(part);
                localStorage.setItem('partsData', JSON.stringify(storedParts));
            }

            function removePartFromTable(id) {
                const storedParts = JSON.parse(localStorage.getItem('partsData')) || [];
                const updatedParts = storedParts.filter(part => part.id !== id);
                localStorage.setItem('partsData', JSON.stringify(updatedParts));
                document.querySelector(`tr[data-id="${id}"]`).remove();
            }

            function viewImages(images) {
                const imageModal = document.createElement('div');
                imageModal.classList.add('image-modal');
                imageModal.innerHTML = `
                    <div class="image-modal-content">
                        <span class="close-button">&times;</span>
                        <div class="image-gallery"></div>
                    </div>
                `;
                document.body.appendChild(imageModal);

                const imageGallery = imageModal.querySelector('.image-gallery');
                images.forEach(src => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.classList.add('image-preview');
                    imageGallery.appendChild(img);
                });

                const closeButton = imageModal.querySelector('.close-button');
                closeButton.addEventListener('click', () => {
                    document.body.removeChild(imageModal);
                });
            }


            partImagesInput.addEventListener('change', () => {
                imagePreviewContainer.innerHTML = '';
                imageFiles = Array.from(partImagesInput.files);
                if (imageFiles.length > 9) {
                    alert("Sie können maximal 9 Bilder hochladen.");
                    partImagesInput.value = '';
                    imageFiles = [];
                    return;
                }
                imageFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const img = document.createElement('div');
                        img.classList.add('image-preview');
                        img.innerHTML = `
                            <img src="${e.target.result}" alt="Preview">
                            <button class="remove-button" data-index="${index}">&times;</button>
                        `;
                        imagePreviewContainer.appendChild(img);

                        // Perform OCR on the image
                        const orcText = await performOCR(e.target.result);
                        console.log(`OCR Result for image ${index + 1}:`, orcText);
                        const orcResultDiv = document.createElement('div');
                        ocrResultDiv.classList.add(`ocr-result`);
                        ocrResultDiv.textContent(`OCR Result: ${orcText}`);
                        img.appendChild(orcResultDiv)
                    };
                    reader.readAsDataURL(file);
                });
            });
            
            
            imagePreviewContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-button')) {
                    const index = e.target.getAttribute('data-index');
                    imageFiles.splice(index, 1);
                    partImagesInput.value = '';
                    imagePreviewContainer.innerHTML = '';
                    imageFiles.forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const img = document.createElement('div');
                            img.classList.add('image-preview');
                            img.innerHTML = `
                                <img src="${e.target.result}" alt="Preview">
                                <button class="remove-button" data-index="${index}">&times;</button>
                            `;
                            imagePreviewContainer.appendChild(img);

                            // Perform OCR on the image
                            const orcText = await performOCR(e.target.result);
                            console.log(`OCR Result for image ${index + 1}:`, orcText);
                            const orcResultDiv = document.createElement('div');
                            ocrResultDiv.classlist.add('ocr-result');
                            ocrResultDiv.textContent(`OCR Result: ${orcText}`);
                            img.appendChild(orcResultDiv);
                        };
                        reader.readAsDataURL(file);
                    });
                }
            });


            function loadPartsFromStorage() {
                storedParts = JSON.parse(localStorage.getItem('partsData')) || [];
                filteredParts = storedParts;
                renderTable();
                if (storedParts.length > 0) exportButton.classList.remove('hidden');
                updateClearButtonVisibility();
            }

            function renderTable() {
                console.log('Rendering table...');
                partsTableBody.innerHTML = '';
                const start = (currentPage - 1) * entriesPerPage;
                const end = start + entriesPerPage;
                const partsToDisplay = filteredParts.slice(start, end);

                partsToDisplay.forEach(addPartToTable);
                updatePaginationButtons();
            }

            function addPartToTable(part) {
                const newRow = document.createElement('tr');
                newRow.setAttribute('data-id', part.id);
                
                for (const key in part) {
                    if (key === 'id' || key === 'images') continue;
                    const cell = document.createElement('td');
                    cell.textContent = key === 'complaintDate' && part[key]
                        ? new Date(part[key]).toLocaleDateString('de-DE')
                        : part[key];
                    newRow.appendChild(cell);
                }

                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <button class="icon-button delete-btn" title="Löschen">
                        <span class="material-icons">delete</span>
                    </button>
                    <button class="icon-button edit-btn" title="Bearbeiten">
                        <span class="material-icons">edit</span>
                    </button>
                    <button class="icon-button view-images-btn" title="Bilder anzeigen">
                        <span class="material-icons">photo</span>
                    </button>
                `;
                actionsCell.querySelector('.delete-btn').addEventListener('click', () => {
                    if (confirm(`Sind Sie sicher, dass Sie den Eintrag mit dem Kennzeichen "${part.licensePlate}" löschen wollen?`))
                        removePartFromTable(part.id);
                }); 

                actionsCell.querySelector('.edit-btn').addEventListener('click', () => loadPartToForm(part));
                actionsCell.querySelector('.view-images-btn').addEventListener('click', () => {
                    if (part.images.length === 0) {
                        if (confirm("Es wurden noch keine Bilder hinzugefügt. Möchten Sie jetzt Bilder hinzufügen?")) {
                            partImagesInput.click();
                        }
                    } else {
                        viewImages(part.images);
                    }
                });
                newRow.appendChild(actionsCell);
                partsTableBody.appendChild(newRow);
            }

            
            function viewImages(images) {
                const imageModal = document.createElement('div');
                imageModal.classList.add('image-modal');
                imageModal.innerHTML = `
                    <div class="image-modal-content">
                        <span class="close-button">&times;</span>
                        <div class="image-gallery"></div>
                    </div>
                `;
                document.body.appendChild(imageModal);

                const imageGallery = imageModal.querySelector('.image-gallery');
                images.forEach(src => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.classList.add('image-preview');
                    imageGallery.appendChild(img);
                });

                const closeButton = imageModal.querySelector('.close-button');
                closeButton.addEventListener('click', () => {
                    document.body.removeChild(imageModal);
                });
            } 

            // OCR Erkennung
            async function performOCR(imageSrc) {
                const {data: {text}} = await Tesseract.recognize(
                    imageSrc,
                    'eng',
                    {
                        logger: m => console.log(m)
                    }
                );
                return text;
            }

            function removePartFromTable(id) {
                storedParts = storedParts.filter(part => part.id !== id);
                localStorage.setItem('partsData', JSON.stringify(storedParts));
                filteredParts = storedParts;
                renderTable();
                if (!partsTableBody.children.length) exportButton.classList.add('hidden');
                updateClearButtonVisibility();
                updateDashboard(); // Aktualisiere die Metriken und Handlungsempfehlungen
            }

            function loadPartToForm(part) {
                document.getElementById('licensePlate').value = part.licensePlate;
                document.getElementById('partNumber').value = part.partNumber;
                document.getElementById('description').value = part.description;
                document.getElementById('complaintDate').value = part.complaintDate;
                document.getElementById('reason').value = part.reason;
                document.getElementById('price').value = part.price;
                document.getElementById('remarks').value = part.remarks;
                document.getElementById('creditAvailable').value = part.creditAvailable;
                addButton.textContent = 'Speichern';
                isEditing = true;
                editingId = part.id;

                // Bilder laden
                imagePreviewContainer.innerHTML = '';
                part.images.forEach((src, index) => {
                    const img = document.createElement('div');
                    img.classList.add('image-preview');
                    img.innerHTML = `
                        <img src="${src}" alt="Preview">
                        <button class="remove-button" data-index="${index}">&times;</button>
                    `;
                    imagePreviewContainer.appendChild(img);
                });
            }

            function savePartToStorage(part) {
                storedParts.push(part);
                localStorage.setItem('partsData', JSON.stringify(storedParts));
                filteredParts = storedParts;
                renderTable();
                updateClearButtonVisibility();
                updateDashboard(); // Aktualisiere die Metriken und Handlungsempfehlungen
            }

            function updatePartInStorage(updatedPart) {
                const partIndex = storedParts.findIndex(part => part.id === updatedPart.id);
                if (partIndex !== -1) storedParts[partIndex] = updatedPart;
                localStorage.setItem('partsData', JSON.stringify(storedParts));
                filteredParts = storedParts;
                renderTable();
                updateClearButtonVisibility();
                updateDashboard(); // Aktualisiere die Metriken und Handlungsempfehlungen
            }

            function updateClearButtonVisibility() {
                if (storedParts.length > 0) {
                    clearTableButton.classList.remove('hidden');
                } else {
                    clearTableButton.classList.add('hidden');
                }
            }

            function updateDashboard() {
                const notReturnedCount = storedParts.length;
                const totalPrice = storedParts.reduce((sum, part) => sum + parseFloat(part.price || 0), 0);
                const creditPrice = storedParts.filter(part => part.creditAvailable === 'Ja').reduce((sum, part) => sum + parseFloat(part.price || 0), 0);
                const openAmount = totalPrice - creditPrice;

                document.getElementById('notReturnedCount').textContent = notReturnedCount;
                document.getElementById('totalPrice').textContent = `${totalPrice.toFixed(2)} €`;
                document.getElementById('creditPrice').textContent = `${creditPrice.toFixed(2)} €`;
                document.getElementById('openAmount').textContent = `${openAmount.toFixed(2)} €`;

                const recommendationText = document.getElementById('recommendationText');
                if (openAmount > 1000) {
                    recommendationText.textContent = "Bitte offene Beträge reduzieren.";
                } else {
                    recommendationText.textContent = "Keine Empfehlungen verfügbar.";
                }
                document.getElementById('dashboard').classList.remove('hidden');
            }

            function updatePaginationButtons() {
                const totalPages = Math.ceil(filteredParts.length / entriesPerPage);
                document.getElementById('pageInfo').textContent = `Seite ${currentPage} von ${totalPages}`;
                prevPageButton.disabled = currentPage === 1;
                nextPageButton.disabled = currentPage >= totalPages;
            }

            entriesPerPageSelect.addEventListener('change', () => {
                entriesPerPage = parseInt(entriesPerPageSelect.value, 10);
                currentPage = 1;
                renderTable();
            });

            prevPageButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });

            nextPageButton.addEventListener('click', () => {
                if (currentPage * entriesPerPage < filteredParts.length) {
                    currentPage++;
                    renderTable();
                }
            });

            searchButton.addEventListener('click', () => {
                const searchTerm = searchInput.value.toLowerCase();
                filteredParts = storedParts.filter(part => 
                    part.licensePlate.toLowerCase().includes(searchTerm) ||
                    part.partNumber.toLowerCase().includes(searchTerm)
                );
                currentPage = 1;
                renderTable();
                clearSearchButton.classList.remove('hidden');
            });

            clearSearchButton.addEventListener('click', () => {
                searchInput.value = '';
                filteredParts = storedParts;
                currentPage = 1;
                renderTable();
                clearSearchButton.classList.add('hidden');
            });

            addPartForm.addEventListener('submit', event => {
                event.preventDefault();

                const newPart = {
                    id: isEditing ? editingId : uniqueId++,
                    licensePlate: document.getElementById('licensePlate').value,
                    partNumber: document.getElementById('partNumber').value,
                    description: document.getElementById('description').value,
                    complaintDate: document.getElementById('complaintDate').value,
                    reason: document.getElementById('reason').value,
                    price: document.getElementById('price').value,
                    remarks: document.getElementById('remarks').value,
                    creditAvailable: document.getElementById('creditAvailable').value,
                    images: []
                };

                const readerPromises = [];
                imageFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    readerPromises.push(new Promise((resolve, reject) => {
                        reader.onload = (e) => {
                            const img = new Image();
                            img.src = e.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                canvas.width = img.width;
                                canvas.height = img.height;
                                ctx.drawImage(img, 0, 0);
                                canvas.toBlob((blob) => {
                                    const webpReader = new FileReader();
                                    webpReader.onload = (webpEvent) => {
                                        newPart.images.push(webpEvent.target.result);
                                        resolve();
                                    };
                                    webpReader.onerror = reject;
                                    webpReader.readAsDataURL(blob);
                                }, 'image/webp');
                            };
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    }));
                });

                Promise.all(readerPromises).then(() => {
                    if (isEditing) {
                        updatePartInStorage(newPart);
                        document.querySelector(`tr[data-id="${editingId}"]`)?.remove();
                        addPartToTable(newPart);
                        isEditing = false;
                        editingId = null;
                        addButton.textContent = 'Hinzufügen';
                    } else {
                        addPartToTable(newPart);
                        savePartToStorage(newPart);
                    }

                    exportButton.classList.remove('hidden');
                    addPartForm.reset();
                    imagePreviewContainer.innerHTML = '';
                    imageFiles = [];
                    updateDashboard();
                    updateClearButtonVisibility();
                }).catch(error => {
                    console.error("Fehler beim Lesen der Bilder:", error);
                });
            });

            exportButton.addEventListener('click', () => {
                const zip = new JSZip();
                const folderName = `Retoure-Ersatzteil-${new Date().toLocaleDateString('de-DE')}`;
                const mainFolder = zip.folder(folderName);
                const imagesFolder = mainFolder.folder('Bilder');

                // Exportiere die Liste als CSV
                const worksheet = XLSX.utils.json_to_sheet(storedParts);
                const csv = XLSX.utils.sheet_to_csv(worksheet);
                mainFolder.file('Liste.csv', csv);

                // Füge die Bilder hinzu
                storedParts.forEach(part => {
                    const partFolderName = `${part.licensePlate}-${part.partNumber}-${new Date(part.complaintDate).toLocaleDateString('de-DE')}`;
                    const partFolder = imagesFolder.folder(partFolderName);
                    part.images.forEach((image, index) => {
                        const base64Data = image.split(',')[1];
                        partFolder.file(`Bild-${index + 1}.jpg`, base64Data, { base64: true });
                    });
                });

                // Generiere das ZIP-Archiv und speichere es
                zip.generateAsync({ type: 'blob' }).then(content => {
                    saveAs(content, `${folderName}.zip`);
                });
            });

            clearTableButton.addEventListener('click', () => {
                if (confirm("Sind Sie sicher, dass Sie alle Einträge löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.")) {
                    localStorage.removeItem('partsData');
                    storedParts = [];
                    filteredParts = [];
                    renderTable();
                    exportButton.classList.add('hidden');
                    clearTableButton.classList.add('hidden');
                    updateDashboard(); // Aktualisiere die Metriken und Handlungsempfehlungen
                    alert("Alle Einträge wurden gelöscht.");
                }
            });

            document.getElementById('importButton').addEventListener('click', () => {
                const fileInput = document.getElementById('importFile');
                const file = fileInput.files[0];

                if (!file) {
                    alert("Bitte wählen Sie eine Datei aus.");
                    return;
                }

                const reader = new FileReader();

                reader.onload = (event) => {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];

                    const importedData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    const headers = importedData[0];
                    importedData.slice(1).forEach((row, index) => {
                        const newPart = {
                            id: uniqueId++,
                            licensePlate: row[headers.indexOf('licensePlate')] || `Unbekannt ${index}`,
                            partNumber: row[headers.indexOf('partNumber')] || "",
                            description: row[headers.indexOf('description')] || "",
                            complaintDate: row[headers.indexOf('complaintDate')] || "",
                            reason: row[headers.indexOf('reason')] || "",
                            price: row[headers.indexOf('price')] || "0",
                            remarks: row[headers.indexOf('remarks')] || "",
                            creditAvailable: row[headers.indexOf('creditAvailable')] || "Nein",
                            images: []
                        };

                        storedParts.push(newPart);
                    });

                    localStorage.setItem('partsData', JSON.stringify(storedParts));
                    filteredParts = storedParts;
                    renderTable();
                    updateDashboard();
                    exportButton.classList.remove('hidden');
                    updateClearButtonVisibility();
                    alert("Import erfolgreich abgeschlossen!");
                };

                reader.onerror = (error) => {
                    alert("Fehler beim Lesen der Datei: " + error.message);
                };

                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
            
            /*
            window.onload = () => {
                loadPartsFromStorage();
                updateDashboard();
                updateClearButtonVisibility();
            }; */

            window.onload = () => {
                loadPartsFromStorage();
                updateDashboard();
                updateClearButtonVisibility();
            };
    </script>
</body>
</html>